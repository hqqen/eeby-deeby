function [M,C,G,E,PE,KE] = dynMatsExtFootForm(q,dq,p)
%helper function to numerically calculate dynamics matrices M (inertia), C
%(coriolis) and G (gravity) given state vector q and its derivatives along
%with hip pos'n vector p

q0 = q(1); tht0 = q(2); q1 = q(3); tht1 = q(4);
dq0 = dq(1); dtht0 = dq(2); dq1 = dq(3); dtht1 = dq(4);
footX = p(1); footY = p(2);


% fprintf("q:\n"); disp(q);
% fprintf("\ndq:\n"); disp(dq);
% fprintf("\nqo:\n"); disp(q0);
% fprintf("\ntht:\n"); disp(tht);
% fprintf("\ndq0:\n"); disp(dq0);
% fprintf("\ndtht:\n"); disp(dtht);

[D,L,g,m,phi,dt,beta,ke,kd,kp,k,nPoints] = getVars();

t2 = cos(phi);
t3 = cos(q0);
t4 = cos(q1);
t5 = sin(phi);
t6 = sin(q0);
t7 = sin(q1);
t8 = phi+tht0;
t9 = phi+tht1;
t10 = D.^2;
t11 = L.^2;
t12 = q1.*2.0;
t13 = q0.*4.0;
t14 = q0.^2;
t15 = q0.^3;
t16 = q1.^2;
t18 = q1.^3;
t19 = q0.^5;
t21 = q1.^5;
t32 = -q1;
t34 = 1.0./q0;
t36 = 1.0./q1;
t44 = -tht0;
t45 = -tht1;
t17 = t14.^2;
t20 = t16.^2;
t22 = t6.*3.0;
t23 = t7.*3.0;
t24 = q0.*t3;
t25 = q1.*t4;
t26 = cos(t8);
t27 = cos(t9);
t28 = q0+t8;
t29 = q1+t9;
t30 = sin(t8);
t31 = sin(t9);
t33 = -t13;
t35 = 1.0./t14;
t37 = 1.0./t15;
t38 = 1.0./t16;
t40 = 1.0./t18;
t41 = 1.0./t19;
t43 = 1.0./t21;
t51 = t11.*8.0;
t52 = t11.*2.4e+1;
t53 = t6.*t14;
t54 = t45+tht0;
t59 = q1+t44+tht1;
t61 = footY.*g.*m.*t2.*2.0;
t64 = q0.*t11.*3.6e+1;
t65 = footX.*g.*m.*t5.*2.0;
t66 = t10.*t15;
t68 = t10.*t18;
t69 = t10.*t19;
t71 = t10.*t21;
t72 = q1.*t11.*7.2e+1;
t79 = t6.*t11.*1.2e+1;
t81 = t6.*t11.*3.6e+1;
t85 = t11.*t14.*1.2e+1;
t86 = t11.*t15.*1.2e+1;
t87 = t11.*t16.*1.2e+1;
t88 = t11.*t18.*1.2e+1;
t89 = t3.*t11.*-8.0;
t90 = t4.*t11.*-2.4e+1;
t92 = t7.*t11.*-2.4e+1;
t94 = t7.*t11.*1.44e+2;
t97 = q0.*t6.*t11.*-8.0;
t39 = 1.0./t17;
t42 = 1.0./t20;
t46 = cos(t28);
t47 = cos(t29);
t48 = sin(t28);
t49 = sin(t29);
t50 = -t23;
t55 = -t26;
t56 = -t27;
t57 = cos(t54);
t58 = q0+t54;
t60 = sin(t54);
t62 = q0.*t52;
t63 = q1.*t52;
t67 = t10.*t17;
t70 = t10.*t20;
t74 = cos(t59);
t76 = sin(t59);
t77 = t3.*t51;
t78 = t4.*t52;
t80 = t7.*t52;
t82 = t11.*t24.*1.2e+1;
t83 = q0.*t6.*t51;
t91 = -t79;
t93 = -t81;
t96 = t11.*t25.*7.2e+1;
t98 = q1.*t92;
t99 = -t94;
t101 = t11.*t53.*1.8e+1;
t103 = L.*g.*m.*t31.*t36;
t106 = t14.*t89;
t108 = L.*g.*m.*t30.*t34.*2.0;
t176 = t22+t24+t33+t53;
t73 = cos(t58);
t75 = sin(t58);
t84 = t7.*t63;
t95 = -t82;
t100 = t14.*t77;
t102 = t32+t58;
t107 = -t101;
t109 = t11.*t57.*1.2e+1;
t110 = t52.*t57;
t111 = t12+t25+t50;
t112 = t11.*t60.*1.2e+1;
t113 = t52.*t60;
t114 = L.*g.*m.*t34.*t46;
t115 = L.*g.*m.*t34.*t48;
t116 = t46+t55;
t117 = t47+t56;
t118 = -t108;
t119 = -t103;
t120 = t11.*t57.*-2.4e+1;
t124 = t11.*t74.*1.2e+1;
t127 = t52.*t74;
t129 = t11.*t76.*1.2e+1;
t132 = t52.*t76;
t138 = q1.*t11.*t57.*-1.2e+1;
t140 = q1.*t11.*t60.*-1.2e+1;
t155 = q1.*t11.*t74.*-1.2e+1;
t157 = dq0.*m.*t11.*t74.*-2.4e+1;
t169 = dtht1.*m.*t57.*t87;
t170 = dtht1.*m.*t60.*t87;
t179 = dtht1.*m.*t11.*t16.*t57.*-1.2e+1;
t193 = -L.*g.*m.*t35.*(t26-t46);
t194 = -L.*g.*m.*t38.*(t27-t47);
t197 = L.*g.*m.*t35.*(t26-t46);
t198 = L.*g.*m.*t38.*(t27-t47);
t199 = t63+t68+t92;
t202 = t52+t70+t87+t90+t98;
t205 = t71+t72+t88+t96+t99;
t209 = t51+t67+t85+t89+t97+t106;
t104 = cos(t102);
t105 = sin(t102);
t121 = q0.*q1.*t10.*t73;
t122 = q0.*q1.*t10.*t75;
t123 = t11.*t73.*1.2e+1;
t125 = q1.*t109;
t126 = t52.*t73;
t128 = t11.*t75.*1.2e+1;
t130 = q1.*t112;
t131 = t52.*t75;
t135 = q1.*t129;
t137 = -t124;
t141 = t11.*t75.*-2.4e+1;
t142 = dq0.*m.*t110;
t144 = q1.*t124;
t145 = t62.*t73;
t146 = q0.*t11.*t75.*-1.2e+1;
t147 = q1.*t11.*t75.*-1.2e+1;
t149 = dq0.*m.*t127;
t151 = q0.*t10.*t32.*t75;
t153 = q1.*t10.*t14.*t73;
t154 = q1.*t10.*t14.*t75;
t156 = dq0.*m.*t11.*t73.*-2.4e+1;
t159 = dq0.*m.*t62.*t75;
t171 = dtht0.*m.*q0.*t138;
t172 = t10.*t14.*t32.*t75;
t174 = dtht0.*m.*q0.*t140;
t175 = dtht1.*m.*t73.*t87;
t177 = dtht1.*m.*t75.*t87;
t186 = dtht1.*m.*t11.*t16.*t75.*-1.2e+1;
t200 = t62+t66+t91+t95;
t201 = (dtht1.*m.*t40.*t199)./1.2e+1;
t204 = t64+t69+t86+t93+t107;
t206 = (m.*t42.*t202)./2.4e+1;
t211 = (dq1.*m.*t43.*t205)./3.6e+1;
t212 = (m.*t39.*t209)./8.0;
t133 = q0.*t128;
t134 = q1.*t128;
t136 = -t123;
t139 = -t128;
t143 = q1.*t123;
t148 = dq0.*m.*t126;
t158 = dtht0.*m.*q0.*t125;
t160 = dtht0.*m.*q0.*t130;
t161 = q0.*q1.*t10.*t104;
t163 = q0.*q1.*t10.*t105;
t165 = t11.*t104.*1.2e+1;
t166 = t52.*t104;
t167 = t11.*t105.*1.2e+1;
t168 = t52.*t105;
t173 = dq0.*m.*q0.*t141;
t178 = t11.*t104.*-2.4e+1;
t181 = t62.*t104;
t185 = q0.*t10.*t32.*t104;
t188 = q1.*t10.*t14.*t104;
t189 = q0.*t10.*t16.*t105;
t190 = q1.*t10.*t14.*t105;
t192 = dq0.*m.*t62.*t105;
t195 = t10.*t14.*t16.*t105;
t196 = t10.*t14.*t32.*t104;
t203 = (dtht0.*m.*t37.*t200)./6.0;
t207 = dq1.*t206;
t208 = dtht1.*t206;
t210 = (dq0.*m.*t41.*t204)./9.0;
t213 = dq0.*t212;
t214 = dtht0.*t212;
t150 = q0.*t143;
t152 = q1.*t133;
t180 = q1.*t165;
t182 = q0.*t167;
t183 = q1.*t167;
t184 = dq0.*m.*t166;
t191 = q0.*t178;
t215 = t112+t129+t138+t139+t143+t151+t163+t167;
t162 = dtht0.*m.*t150;
t164 = dtht0.*m.*t152;
t187 = q1.*t182;
t216 = (m.*t34.*t38.*t215)./1.2e+1;
t220 = dtht0.*m.*t34.*t38.*t215.*(-1.0./1.2e+1);
t221 = dtht1.*m.*t34.*t38.*t215.*(-1.0./1.2e+1);
t222 = t120+t121+t126+t127+t134+t135+t140+t178+t183+t185+t189;
t223 = t109+t130+t136+t137+t146+t147+t150+t165+t172+t182+t190;
t217 = dtht0.*t216;
t218 = dtht1.*t216;
t219 = -t216;
t224 = (m.*t34.*t40.*t222)./1.2e+1;
t227 = (m.*t35.*t38.*t223)./1.2e+1;
t231 = dq1.*m.*t34.*t40.*t222.*(-1.0./1.2e+1);
t232 = dtht0.*m.*t34.*t40.*t222.*(-1.0./1.2e+1);
t234 = dq0.*m.*t35.*t38.*t223.*(-1.0./1.2e+1);
t235 = dtht1.*m.*t35.*t38.*t223.*(-1.0./1.2e+1);
t236 = t113+t132+t138+t141+t143+t145+t152+t153+t155+t168+t180+t187+t191+t195+t196;
t225 = dq1.*t224;
t226 = dtht0.*t224;
t228 = -t224;
t229 = dq0.*t227;
t230 = dtht1.*t227;
t233 = -t227;
t237 = (m.*t35.*t40.*t236)./1.2e+1;
t241 = dq0.*m.*t35.*t40.*t236.*(-1.0./1.2e+1);
t242 = dq1.*m.*t35.*t40.*t236.*(-1.0./1.2e+1);
t243 = t201+t207+t220+t234;
t245 = t203+t213+t221+t231;
t238 = dq0.*t237;
t239 = dq1.*t237;
t240 = -t237;
M = reshape([(m.*t41.*t204)./9.0,t212,t240,t233,t212,(m.*t37.*t200)./6.0,t228,t219,t240,t228,(m.*t43.*t205)./3.6e+1,t206,t233,t219,t206,(m.*t40.*t199)./1.2e+1],[4,4]);
if nargout > 1
    et1 = t170+t186+q0.*t175-dq1.*m.*t188.*2.0+dtht1.*m.*t195+dq1.*m.*q1.*t120+dq1.*m.*t11.*t60.*7.2e+1-dq1.*m.*t11.*t75.*7.2e+1+dq1.*m.*t11.*t76.*7.2e+1+dq1.*m.*t11.*t105.*7.2e+1+dq1.*m.*t63.*t73+dq1.*m.*t12.*t190+dtht1.*m.*t57.*t63+dtht1.*m.*t63.*t104+dtht1.*m.*q0.*q1.*t141+dq1.*m.*q0.*t11.*t73.*7.2e+1-dq1.*m.*q1.*t11.*t74.*4.8e+1-dq1.*m.*q0.*t11.*t104.*7.2e+1+dq1.*m.*q1.*t11.*t104.*4.8e+1+dq1.*m.*q1.*t62.*t75+dq1.*m.*q0.*t87.*t104-dtht1.*m.*q1.*t11.*t73.*2.4e+1-dtht1.*m.*q1.*t11.*t74.*2.4e+1+dtht1.*m.*q1.*t62.*t105+dtht1.*m.*q0.*t87.*t104-dq1.*m.*t11.*t16.*t76.*1.2e+1-dq1.*m.*t11.*t16.*t105.*1.2e+1+dq1.*m.*t14.*t68.*t104-dtht1.*m.*t11.*t16.*t76.*1.2e+1-dtht1.*m.*t11.*t16.*t105.*1.2e+1;
    et2 = dtht1.*m.*t14.*t68.*t104+dq1.*m.*t10.*t12.*t14.*t73-dtht1.*m.*t10.*t14.*t16.*t75+dq1.*m.*q0.*q1.*t11.*t105.*4.8e+1;
    et3 = t164+t174+q1.*t157+q1.*t159+q1.*t192+dtht0.*m.*t145+dtht0.*m.*t187+dtht0.*m.*t191+dq0.*m.*q1.*t120+dtht0.*m.*q0.*t120+dtht0.*m.*q0.*t135+dq0.*m.*t11.*t60.*4.8e+1-dq0.*m.*t11.*t75.*4.8e+1+dq0.*m.*t11.*t76.*4.8e+1+dq0.*m.*t11.*t105.*4.8e+1+dq0.*m.*t63.*t73+dq0.*m.*t14.*t131+dq0.*m.*t63.*t104+dtht0.*m.*t62.*t74+dtht0.*m.*t14.*t131+dq0.*m.*q0.*t11.*t73.*4.8e+1-dq0.*m.*q0.*t11.*t104.*4.8e+1+dq0.*m.*q1.*t66.*t75+dtht0.*m.*q1.*t66.*t75-dq0.*m.*t11.*t14.*t105.*2.4e+1-dq0.*m.*t16.*t66.*t104+dq0.*m.*t32.*t66.*t105-dtht0.*m.*t11.*t14.*t105.*2.4e+1-dtht0.*m.*t16.*t66.*t104+dtht0.*m.*t32.*t66.*t105-dq0.*m.*q1.*t11.*t14.*t73.*1.2e+1-dq0.*m.*q1.*t11.*t14.*t104.*1.2e+1-dtht0.*m.*q1.*t11.*t14.*t73.*1.2e+1;
    et4 = dtht0.*m.*q1.*t11.*t14.*t104.*-1.2e+1;
    mt1 = [dq0.*m.*t11.*t35.^3.*(q0.*2.4e+1-t6.*3.0e+1+t24.*6.0-t53.*9.0+t3.*t15.*3.0+t13.*t14).*(-1.0./3.0),m.*t11.*t41.*(dq0.*-4.0+dq0.*t3.*4.0-dq0.*t14.*3.0-dtht0.*t14.*4.0+dtht0.*q0.*t22+dq0.*t3.*t14+dq0.*t6.*t13+dq0.*t6.*t15+dtht0.*t3.*t14+dtht0.*t6.*t15),(t37.*t40.*(et3+et4))./1.2e+1];
    mt2 = [(t37.*t38.*(t142+t156+t157+t162+t171+t173+t184+t192+dtht0.*m.*t146+dtht0.*m.*t182+dq0.*m.*q1.*t141+dq0.*m.*q1.*t145+dtht0.*m.*q0.*t112+dtht0.*m.*q0.*t129+dq0.*m.*t60.*t63+dq0.*m.*t73.*t85+dtht0.*m.*t73.*t85+dq0.*m.*q1.*t66.*t73+dq0.*m.*q1.*t75.*t85+dtht0.*m.*q1.*t66.*t73+dtht0.*m.*q1.*t75.*t85-dq0.*m.*t11.*t14.*t104.*1.2e+1+dq0.*m.*t32.*t66.*t104-dtht0.*m.*t11.*t14.*t104.*1.2e+1+dtht0.*m.*t32.*t66.*t104))./1.2e+1,-dtht0.*m.*t11.*t39.*t176,dq0.*m.*t11.*t39.*t176];
    mt3 = [t35.*t40.*(t142+t156+t157+t162+t171+t173+t184+t192+dq0.*m.*t130+dq0.*m.*t147+dq0.*m.*t150+dq0.*m.*t172+dq0.*m.*t190+dtht0.*m.*t172+dtht0.*m.*t190+dq0.*m.*q0.*t180+dtht0.*m.*q0.*t141+dtht0.*m.*q0.*t155+dtht0.*m.*q0.*t180+dtht0.*m.*t60.*t62+dtht0.*m.*t62.*t76+dtht0.*m.*t62.*t105-dq0.*m.*q1.*t11.*t76.*1.2e+1-dq0.*m.*q1.*t11.*t105.*1.2e+1+dq0.*m.*t10.*t14.*t16.*t104+dtht0.*m.*t10.*t14.*t16.*t104).*(-1.0./1.2e+1)];
    mt4 = [(t35.*t38.*(t164+t174+dq0.*m.*t112+dq0.*m.*t129+dq0.*m.*t138+dq0.*m.*t143+dq0.*m.*t152+dq0.*m.*t153+dq0.*m.*t167+dq0.*m.*t196+dtht0.*m.*t153+dtht0.*m.*t196+dq0.*m.*q0.*t123+dtht0.*m.*q0.*t123+dtht0.*m.*q0.*t124-dq0.*m.*t11.*t75.*1.2e+1-dq0.*m.*q0.*t11.*t104.*1.2e+1-dtht0.*m.*q0.*t11.*t57.*1.2e+1-dtht0.*m.*q0.*t11.*t104.*1.2e+1))./1.2e+1,(t35.*t42.*(et1+et2))./1.2e+1];
    mt5 = [(t34.*t42.*(t175+t179-dq1.*m.*t161.*2.0+dtht1.*m.*t189+dtht1.*m.*q1.*t141-dq1.*m.*t11.*t57.*7.2e+1+dq1.*m.*t11.*t73.*7.2e+1+dq1.*m.*t11.*t74.*7.2e+1-dq1.*m.*t11.*t104.*7.2e+1+dq1.*m.*t63.*t75+dq1.*m.*t12.*t163+dq1.*m.*t87.*t104+dtht1.*m.*t60.*t63+dtht1.*m.*t63.*t76+dtht1.*m.*t63.*t105+dtht1.*m.*t87.*t104-dq1.*m.*q1.*t11.*t60.*2.4e+1+dq1.*m.*q1.*t11.*t76.*4.8e+1+dq1.*m.*q1.*t11.*t105.*4.8e+1+dq1.*m.*q0.*t68.*t104+dtht1.*m.*q0.*t68.*t104-dq1.*m.*t11.*t16.*t74.*1.2e+1-dtht1.*m.*t11.*t16.*t74.*1.2e+1+dq1.*m.*q0.*t10.*t12.*t73-dtht1.*m.*q0.*t10.*t16.*t75))./1.2e+1,dq1.*m.*t11.*t38.^3.*(q1.*1.2e+1-t7.*3.0e+1+t18+t25.*1.8e+1+t16.*t23).*(-1.0./3.0)];
    mt6 = [-m.*t11.*t43.*(dq1.*4.0-dq1.*t4.*4.0+dq1.*t16-dq1.*q1.*t7.*4.0-dtht1.*q1.*t7.*3.0+dtht1.*q1.*t12+dq1.*t4.*t16+dtht1.*t4.*t16),t35.*t40.*(t175+t179+q0.*t177+dq1.*m.*t120+dq1.*m.*t126+dq1.*m.*t127+dq1.*m.*t134+dq1.*m.*t135+dq1.*m.*t140+dq1.*m.*t154+dq1.*m.*t178+dq1.*m.*t183+dtht1.*m.*t130+dtht1.*m.*t135+dtht1.*m.*t147+dtht1.*m.*t150+dtht1.*m.*t183+dq1.*m.*t62.*t75-dq1.*m.*q0.*t11.*t105.*2.4e+1-dq1.*m.*t10.*t14.*t16.*t104+dq1.*m.*t10.*t14.*t32.*t105+dtht1.*m.*t10.*t14.*t16.*t73-dtht1.*m.*t10.*t14.*t16.*t104-dq1.*m.*q0.*q1.*t11.*t73.*1.2e+1-dq1.*m.*q0.*q1.*t11.*t104.*1.2e+1-dtht1.*m.*q0.*q1.*t11.*t104.*1.2e+1).*(-1.0./1.2e+1)];
    mt7 = [(t34.*t40.*(t170+t186+dq1.*m.*t113+dq1.*m.*t132+dq1.*m.*t138+dq1.*m.*t141+dq1.*m.*t143+dq1.*m.*t151+dq1.*m.*t155+dq1.*m.*t163+dq1.*m.*t168+dq1.*m.*t180+dtht1.*m.*t125+dtht1.*m.*t155+dtht1.*m.*t180-dtht1.*m.*q1.*t11.*t73.*1.2e+1+dq1.*m.*q0.*t10.*t16.*t104-dtht1.*m.*q0.*t10.*t16.*t73+dtht1.*m.*q0.*t10.*t16.*t104))./1.2e+1,dtht1.*m.*t11.*t42.*t111,-dq1.*m.*t11.*t42.*t111];
    C = reshape([mt1,mt2,mt3,mt4,mt5,mt6,mt7],4,4);
end
if nargout > 2
    G = [t114+L.*g.*m.*t30.*t35.*2.0-L.*g.*m.*t37.*(t26-t46).*2.0;t114-L.*g.*m.*t26.*t34.*2.0-L.*g.*m.*t35.*(t30-t48);L.*g.*m.*t31.*t38+L.*g.*m.*t38.*t49-L.*g.*m.*t40.*(t27-t47).*2.0;L.*g.*m.*t36.*t56-L.*g.*m.*t38.*(t31-t49)];
end
if nargout > 3
    t244 = (dtht1.*t243)./2.0;
    t246 = (dtht0.*t245)./2.0;
    t247 = t208+t211+t232+t241;
    t249 = t210+t214+t235+t242;
    t248 = (dq1.*t247)./2.0;
    t250 = (dq0.*t249)./2.0;
    E = t61+t65+t115+t118+t119+t197+t198+t244+t246+t248+t250+(k.*t14)./2.0+(k.*t16)./2.0;
end
if nargout > 4
    PE = t61+t65+t115+t118+t119+t197+t198;
end
if nargout > 5
    KE = t244+t246+t248+t250;
end
